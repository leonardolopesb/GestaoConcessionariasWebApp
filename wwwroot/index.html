<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestão de Concessionária — Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet">
</head>

<body>
    <header class="container my-4">
        <div class="section-soft p-4 text-center">
            <h1 class="h3 mb-1">Sistema de Gestão de Concessionária</h1>
            <p class="lead-sm mb-0">Gerencie fabricantes, dados e usuários de forma simples e organizada.</p>
        </div>
    </header>

    <main class="container d-flex justify-content-center" style="min-height:60vh;">
        <div class="card auth-card p-4 d-flex justify-content-center text-center" style="background-color: #bbbbbb; max-width:450px; width:100%; height: 300px;">
            <div class="w-100">
                <h1 class="h4 mb-4">Login</h1>

                <form id="frmLogin" class="vstack gap-3">
                    <input id="NomeUsuario" class="form-control" placeholder="Nome do Usuário" required />
                    <input id="Password" class="form-control" type="password" placeholder="Senha" required />
                    <button class="btn btn-primary w-100">Entrar</button>
                </form>

                <div id="msg" class="mt-3 small "></div>
            </div>
        </div>

    </main>

    <footer class="container site-footer text-center">
        <small>Leonardo Lopes Braga © 2025</small>
    </footer>

    <!-- Scripts -->
    <script src="/js/auth-guard.js"></script>
    <script>
        // se já estiver logado, pula direto para home correta
        redirectIfLoggedIn();

        const form = document.getElementById('frmLogin');
        const msg = document.getElementById('msg');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.textContent = '';

            const body = {
                NomeUsuario: document.getElementById('NomeUsuario').value,
                Password: document.getElementById('Password').value
            };

            const loginResp = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(body)
            });

            if (!loginResp.ok) {
                msg.className = 'text-danger small';
                msg.textContent = 'Credenciais inválidas.';
                return;
            }

            const userResponse = await fetch('/auth/me', { credentials: 'include' });
            if (!userResponse.ok) {
                msg.className = 'text-warning small';
                msg.textContent = 'Falha ao obter perfil.';
                return;
            }

            const user = await userResponse.json();
            const nivel = user.accessLevel.toString();

            if (/Admin/i.test(nivel))
                location.href = '/acessLevel/admin/home.html';

            else if (/Gerente/i.test(nivel))
                location.href = '/acessLevel/gerente/home.html';

            else if (/Vendedor/i.test(nivel))
                location.href = '/acessLevel/vendedor/home.html';
            
            else {
                msg.className = 'text-warning small';
                msg.textContent = 'Perfil sem página configurada.';
            }
        });
    </script>
</body>

</html>