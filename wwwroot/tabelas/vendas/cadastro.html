<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Nova Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .hint { font-size:.875rem; color:#6c757d }
  </style>
</head>
<body class="container py-4" style="max-width:900px">
  <h1 class="mb-4">Nova Venda</h1>
  <div id="msg"></div>

  <form id="frmVenda" class="vstack gap-4">

    <!-- Veículo -->
    <section class="card p-3">
      <h2 class="h5 mb-3">Veículo</h2>

      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Fabricante (por nome)</label>
          <select id="fabricante" class="form-select" required>
            <option value="">Carregando...</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Modelo (do fabricante escolhido)</label>
          <select id="modelo" class="form-select" disabled required>
            <option value="">Selecione um fabricante</option>
          </select>
          <div id="precoBase" class="hint mt-1"></div>
        </div>
      </div>
    </section>

    <!-- Concessionária -->
    <section class="card p-3">
      <h2 class="h5 mb-3">Concessionária</h2>
      <label class="form-label">Nome (valor único)</label>
      <select id="concessionaria" class="form-select" required>
        <option value="">Carregando...</option>
      </select>
      <div id="concHint" class="hint mt-1"></div>
    </section>

    <!-- Cliente -->
    <section class="card p-3">
      <h2 class="h5 mb-3">Dados do Cliente</h2>
      <div class="row g-2">
        <div class="col-md-4"><input id="cpf" class="form-control" placeholder="CPF (11 dígitos)" maxlength="11" required></div>
        <div class="col-md-4"><input id="nome" class="form-control" placeholder="Nome" maxlength="100" required></div>
        <div class="col-md-4"><input id="tel"  class="form-control" placeholder="Telefone" maxlength="20" required></div>
      </div>
      <div id="cliHint" class="hint mt-1"></div>
    </section>

    <!-- Venda -->
    <section class="card p-3">
      <h2 class="h5 mb-3">Dados da Venda</h2>
      <div class="row g-2">
        <div class="col-md-6"><input id="data" type="datetime-local" class="form-control" required></div>
        <div class="col-md-6"><input id="preco" type="number" step="0.01" class="form-control" placeholder="Preço de venda (R$)" required></div>
      </div>
      <div id="precoHint" class="hint mt-1"></div>
    </section>

    <div class="d-flex gap-2">
      <button class="btn btn-success btn-sm">Finalizar Venda</button>
      <a class="btn btn-outline-secondary btn-sm" href="/tabelas/vendas/vendas.html">Voltar</a>
    </div>
  </form>

  <script src="/js/auth-guard.js"></script>
  <script>
    // exige login como Vendedor
    try { requireAuth('Vendedor'); } catch {}

    const msg = document.getElementById('msg');
    const showMsg = (t, type='danger') => { msg.className = `alert alert-${type}`; msg.textContent = t; };
    const clearMsg = () => { msg.className = ''; msg.textContent = ''; };

    // elementos
    const fabricante = document.getElementById('fabricante');
    const modelo = document.getElementById('modelo');
    const precoBase = document.getElementById('precoBase');
    const concessionaria = document.getElementById('concessionaria');
    const concHint = document.getElementById('concHint');

    const cpf = document.getElementById('cpf');
    const nome = document.getElementById('nome');
    const tel  = document.getElementById('tel');
    const cliHint = document.getElementById('cliHint');

    const data = document.getElementById('data');
    const preco = document.getElementById('preco');
    const precoHint = document.getElementById('precoHint');

    // caches
    let fabricantes = [];
    let veiculos = [];
    let concessionarias = [];

    // boot: carrega listas e seta data atual
    (async function boot(){
      try {
        const [rf, rv, rc] = await Promise.all([
          fetch('/api/fabricantes',     { credentials:'include' }),
          fetch('/api/veiculos',        { credentials:'include' }),
          fetch('/api/concessionarias', { credentials:'include' })
        ]);
        if (!rf.ok || !rv.ok || !rc.ok) throw new Error('Falha ao carregar dados');

        fabricantes   = await rf.json();
        veiculos      = await rv.json();
        concessionarias = await rc.json();

        // fabricantes
        fabricante.innerHTML = '<option value="">Selecione</option>';
        for (const f of fabricantes) {
          const opt = document.createElement('option');
          opt.value = f.id; opt.textContent = f.nomeFabricante;
          fabricante.appendChild(opt);
        }

        // concessionárias
        concessionaria.innerHTML = '<option value="">Selecione</option>';
        for (const c of concessionarias) {
          const opt = document.createElement('option');
          opt.value = c.id; opt.textContent = c.nome;
          concessionaria.appendChild(opt);
        }

        // data agora (no fuso local)
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        data.value = now.toISOString().slice(0,16);
      } catch(e){
        console.error(e);
        showMsg('Erro ao carregar dados iniciais.');
      }
    })();

    // ao escolher fabricante ➜ popula modelos
    fabricante.addEventListener('change', () => {
      precoBase.textContent = '';
      precoHint.textContent = '';
      modelo.innerHTML = '<option value="">Selecione o modelo</option>';
      modelo.disabled = true;

      const id = fabricante.value;
      if (!id) return;

      const modelos = veiculos.filter(v => (v.fabricanteId === id) || (v.fabricante?.id === id));
      if (!modelos.length) {
        modelo.innerHTML = '<option value="">Nenhum modelo para este fabricante</option>';
        return;
      }

      for (const v of modelos) {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.modelo;
        opt.dataset.preco = v.preco;
        modelo.appendChild(opt);
      }
      modelo.disabled = false;
    });

    // quando seleciona o modelo ➜ mostra preço base
    modelo.addEventListener('change', () => {
      const opt = modelo.selectedOptions[0];
      if (!opt) { precoBase.textContent = ''; return; }
      const p = Number(opt.dataset.preco || 0);
      precoBase.textContent = p ? `Preço base do veículo: ${p.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}` : '';
      precoHint.textContent = p ? `O preço de venda deve ser ≤ ${p.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}` : '';
    });

    // dica da concessionária
    concessionaria.addEventListener('change', () => {
      const c = concessionarias.find(x => x.id === concessionaria.value);
      concHint.textContent = c ? `${c.cidade ?? ''} / ${c.estado ?? ''}` : '';
    });

    // busca cliente por CPF para preencher automático
    cpf.addEventListener('blur', async () => {
      const raw = cpf.value.replace(/\D/g,'');
      cliHint.textContent = '';
      if (raw.length !== 11) { cliHint.textContent = 'CPF deve ter 11 dígitos.'; return; }
      try{
        const r = await fetch(`/api/clientes/by-cpf?cpf=${raw}`, { credentials:'include' });
        if (r.ok) {
          const c = await r.json();
          if (c?.id) {
            cliHint.textContent = 'Cliente encontrado.';
            if (!nome.value) nome.value = c.nome || '';
            if (!tel.value)  tel.value  = c.telefone || '';
          } else {
            cliHint.textContent = 'Cliente não encontrado. Será criado.';
          }
        }
      } catch {}
    });

    document.getElementById('frmVenda').addEventListener('submit', async (e) => {
      e.preventDefault(); clearMsg();

      if (!fabricante.value)  return showMsg('Selecione o fabricante.');
      if (!modelo.value)      return showMsg('Selecione o modelo.');
      if (!concessionaria.value) return showMsg('Selecione a concessionária.');

      const cpfNum = cpf.value.replace(/\D/g,'');
      if (!/^\d{11}$/.test(cpfNum)) return showMsg('CPF inválido (11 dígitos).');

      const opt = modelo.selectedOptions[0];
      const precoBaseNum = Number(opt?.dataset?.preco || 0);
      const precoNum = Number(preco.value);
      if (!(precoNum > 0)) return showMsg('Preço de venda deve ser positivo.');
      if (precoBaseNum && precoNum > precoBaseNum) return showMsg('Preço de venda não pode exceder o preço do veículo.');

      const fabricanteNome = (fabricantes.find(f => f.id === fabricante.value) || {}).nomeFabricante || '';
      const concNome       = (concessionarias.find(c => c.id === concessionaria.value) || {}).nome || '';
      const veiculoModelo  = (veiculos.find(v => v.id === modelo.value) || {}).modelo || '';

      const body = {
        ConcessionariaNomeOuLocalizacao: concNome,
        FabricanteNome: fabricanteNome,
        VeiculoModelo: veiculoModelo,
        NomeCliente: nome.value.trim(),
        CpfCliente: cpfNum,
        TelefoneCliente: tel.value.trim(),
        DataVenda: data.value ? new Date(data.value).toISOString() : null,
        PrecoVenda: precoNum
      };

      try{
        const r = await fetch('/api/vendas', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(body)
        });

        if (!r.ok) {
          const t = await r.text();
          return showMsg('Erro ao registrar venda: ' + t);
        }

        const created = await r.json();
        showMsg(`Venda registrada! Protocolo: ${created.protocoloVenda}`, 'success');
      }catch(ex){
        showMsg('Erro de rede: ' + (ex?.message || ex));
      }
    });
  </script>
</body>
</html>