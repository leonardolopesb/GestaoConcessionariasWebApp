<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Cadastrar Concessionária</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container py-4" style="max-width:1200px">
    <h1 class="mb-4">Cadastrar Nova Concessionária</h1>
    <div id="msg" class="mb-3"></div>

    <form id="frmNova" class="vstack gap-3">
        <input id="nome" class="form-control" maxlength="100" placeholder="Nome da Concessionária" required>

        <div class="row g-2">
            <div class="col-md-4">
                <input id="cep" class="form-control" placeholder="CEP (00000-000)" minlength="8" maxlength="10"
                    required>
            </div>

            <div class="col-md-4">
                <input id="cidade" class="form-control" placeholder="Cidade" maxlength="50" required>
            </div>

            <div class="col-md-4">
                <input id="estado" class="form-control" placeholder="Estado" maxlength="50" required>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-8">
                <input id="endereco" type="text" class="form-control" placeholder="Rua, Avenida, etc" maxlength="255"
                    required>
            </div>
            <div class="col-md-4">
                <input id="addressNumber" min="1" class="form-control" placeholder="Número do endereço" maxlength="4" required>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-6">
                <input id="telefone" class="form-control" placeholder="Telefone" minlength="8" maxlength="15" required>
            </div>
            <div class="col-md-6">
                <input id="email" class="form-control" type="email" placeholder="E-mail" maxlength="100" required>
            </div>
        </div>

        <input id="capacidade" type="number" min="1" class="form-control" placeholder="Capacidade Máxima de Veículos"
            required>

        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm">Salvar</button>
            <a href="/tabelas/concessionarias/home.html" class="btn btn-outline-secondary btn-sm">Voltar</a>
        </div>
    </form>

    <script src="/js/auth-guard.js"></script>

    <script>
        // somente o administrador pode acessar a página de cadastro
        requireAuth('Admin');

        const reCep = /^\d{8}$/;
        const reTelefone = /^[0-9()\-\s+]{8,15}$/;
        const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const min = { telefone: 8 };
        const max = { nome: 100, telefone: 15, estado: 50, cidade: 50, endereco: 255 };

        // cache
        const frm = document.getElementById('frmNova');
        const nome = document.getElementById('nome');
        const cep = document.getElementById('cep');
        const estado = document.getElementById('estado');
        const cidade = document.getElementById('cidade');
        const endereco = document.getElementById('endereco');
        const addressNumber = document.getElementById('addressNumber');
        const telefone = document.getElementById('telefone');
        const email = document.getElementById('email');
        const capacidade = document.getElementById('capacidade');
        const msgEl = document.getElementById('msg');

        let cepValidoViaCEP = false;

        const showMsg = (t, type = 'danger') => { msgEl.className = `alert alert-${type}`; msgEl.textContent = t; };
        const clearMsg = () => { msgEl.className = ''; msgEl.textContent = ''; };

        // Normaliza CEP enquanto digita
        cep.addEventListener('input', () => {
            cep.value = cep.value.replace(/\D/g, '').slice(0, 8);
            cepValidoViaCEP = false;
        });

        // Consulta ViaCEP ao sair do campo
        cep.addEventListener('blur', async () => {
            cepValidoViaCEP = false;

            if (!reCep.test(cep.value)) {
                showMsg('CEP inválido. Insira 8 dígitos.');
                return;
            }

            try {
                const r = await fetch(`https://viacep.com.br/ws/${cep.value}/json/`);

                const data = await r.json();
                if (data.erro) {
                    showMsg('CEP não encontrado.');
                    return;
                }

                // Preenche automaticamente
                estado.value = data.estado || '';
                cidade.value = data.localidade || '';
                endereco.value = data.logradouro || '';

                const partes = [data.logradouro, data.bairro, data.complemento].filter(Boolean);

                if (!endereco.value)
                    endereco.value = partes.join(', ');

                clearMsg();
                cepValidoViaCEP = true;
            } catch {
                showMsg('Erro ao consultar a API.');
            }
        });

        function validateForm() {
            const v = {
                nome: nome.value,
                cep: cep.value,
                cidade: cidade.value,
                estado: estado.value,
                endereco: endereco.value,
                addressNumber: Number(addressNumber.value),
                telefone: telefone.value,
                email: email.value,
                capacidade: capacidade.value
            };

            // obrigatoriedade
            if (!v.nome) return 'O Nome é obrigatório.';
            if (!v.cep) return 'O CEP é obrigatório.';
            if (!v.cidade) return 'A Cidade é obrigatória.';
            if (!v.estado) return 'O Estado é obrigatório.';
            if (!v.endereco) return 'O Endereço é obrigatório.';
            if (!v.addressNumber) return 'O Número do endereço é obrigatório e precisa ser um número válido.';
            if (!v.telefone) return 'O Telefone é obrigatório.';
            if (!v.email) return 'O E-mail é obrigatório.';
            if (!v.capacidade) return 'A Capacidade é obrigatória.';

            // tamanhos
            if (v.nome.length > max.nome) return `Nome: máximo ${max.nome} caracteres.`;
            if (v.cidade.length > max.cidade) return `Cidade: máximo ${max.cidade} caracteres.`;
            if (v.estado.length > max.estado) return `Estado: máximo ${max.estado} caracteres.`;
            if (v.endereco.length > max.endereco) return `Endereço: máximo ${max.endereco} caracteres.`;
            if (v.telefone.length < min.telefone || v.telefone.length > max.telefone) return 'Telefone: mínimo 8 e máximo 15 caracteres.';
            if (v.addressNumber < 0) return `O número do endereço precisa ser um valor positivo.`;

            // formatando valores
            if (!reTelefone.test(v.telefone)) return 'Telefone inválido. Digite somente números.';
            if (!reEmail.test(v.email)) return 'E-mail inválido. Formato incorreto.';

            // capacidade máxima de veículos
            const cap = Number(v.capacidade);
            if (!Number.isInteger(cap) || cap <= 0) return 'Capacidade deve ser um inteiro maior que zero.';

            // exigimos validação ViaCEP bem-sucedida
            if (!cepValidoViaCEP) return 'Valide o CEP antes de salvar.';

            return null;
        }

        frm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMsg();

            const error = validateForm();
            if (error) {
                showMsg(error);
                return;
            }

            // payload
            const body = {
                nome: nome.value,
                cep: cep.value.replace(/\D/g, ''),
                cidade: cidade.value,
                estado: estado.value,
                endereco: `${endereco.value}, nº ${addressNumber.value}`,
                telefone: telefone.value,
                email: email.value,
                capacidadeMaximaVeiculos: capacidade.value
            };

            try {
                const response = await fetch('/api/concessionarias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    showMsg(`Concessionária ${nome.value} cadastrada com sucesso!`, 'success');
                }

                else if (response.status === 409) {
                    showMsg('Já existe uma concessionária com esse nome.');
                }

                else {
                    const txt = await response.text();
                    showMsg('Erro ao cadastrar: ' + txt);
                }
            } catch (ex) {
                showMsg('Erro de rede: ' + (ex?.message || ex));
            }
        });
    </script>

</body>

</html>